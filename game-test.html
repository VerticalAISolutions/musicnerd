<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MusicNerd</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&display=swap" rel="stylesheet">
    <style>
        :root {
            --electric-aqua: #87F1FF;
            --icy-aqua: #C0F5FA;
            --old-rose: #BD8B9C;
            --cherry-rose: #AF125A;
            --dark-blue: #0f1a2e;
        }
        * {
            box-sizing: border-box;
        }
        body {
            font-family: 'DM Sans', sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            padding-bottom: 60px;
            background: var(--dark-blue);
            color: var(--icy-aqua);
            min-height: 100vh;
        }

        /* Footer */
        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 15px;
            text-align: center;
            font-size: 14px;
            color: var(--old-rose);
            opacity: 0.7;
        }
        .footer a {
            color: var(--old-rose);
            text-decoration: none;
        }
        .footer a:hover {
            color: var(--icy-aqua);
            opacity: 1;
        }

        /* Intro Screen */
        .intro-screen {
            text-align: center;
            padding: 30px 0;
        }
        .intro-title {
            font-size: 38px;
            font-weight: 700;
            color: var(--electric-aqua);
            margin-bottom: 35px;
        }
        .intro-lead {
            font-size: 18px;
            line-height: 1.6;
            color: var(--icy-aqua);
            margin-bottom: 35px;
            text-align: center;
        }
        .intro-section {
            text-align: left;
            margin-bottom: 28px;
        }
        .intro-section-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--electric-aqua);
            margin-bottom: 8px;
        }
        .intro-section-text {
            font-size: 16px;
            line-height: 1.6;
            color: var(--old-rose);
        }
        .intro-ready {
            font-size: 22px;
            font-weight: 600;
            color: var(--icy-aqua);
            margin-top: 40px;
            margin-bottom: 15px;
        }
        .intro-btn {
            width: 100%;
            padding: 18px;
            font-size: 20px;
            font-family: 'DM Sans', sans-serif;
            font-weight: 700;
            background: var(--cherry-rose);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
        }
        .intro-btn:hover {
            background: #c91a6a;
        }
        .setup-nav {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .setup-nav .back-btn {
            flex: 1;
            padding: 14px;
            font-size: 16px;
            font-family: 'DM Sans', sans-serif;
            font-weight: 600;
            background: transparent;
            color: var(--old-rose);
            border: 2px solid var(--old-rose);
            border-radius: 10px;
            cursor: pointer;
        }
        .setup-nav .back-btn:hover {
            border-color: var(--icy-aqua);
            color: var(--icy-aqua);
        }
        .setup-nav .next-btn {
            flex: 2;
            padding: 14px;
            font-size: 16px;
            font-family: 'DM Sans', sans-serif;
            font-weight: 600;
            background: var(--cherry-rose);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
        }
        .setup-nav .next-btn:hover {
            background: #c91a6a;
        }
        h1 {
            color: var(--electric-aqua);
            text-align: center;
            margin-bottom: 30px;
            font-weight: 700;
        }
        .container {
            width: 100%;
        }

        /* Setup Screen */
        .setup-screen {
            width: 100%;
        }
        .setup-section {
            margin-bottom: 25px;
            text-align: left;
        }
        .setup-label {
            font-size: 16px;
            font-weight: 600;
            color: var(--electric-aqua);
            margin-bottom: 12px;
            display: block;
        }

        /* Player Setup */
        .player-count {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        .player-count-btn {
            width: 44px;
            height: 44px;
            border: 2px solid var(--old-rose);
            background: transparent;
            color: var(--icy-aqua);
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .player-count-btn.selected {
            background: var(--cherry-rose);
            border-color: var(--cherry-rose);
            color: white;
        }
        .player-count-btn:hover {
            border-color: var(--electric-aqua);
        }
        .player-inputs {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .player-name-input {
            padding: 12px 15px;
            border: none;
            border-radius: 8px;
            background: rgba(192, 245, 250, 0.1);
            color: var(--icy-aqua);
            font-family: 'DM Sans', sans-serif;
            font-size: 16px;
        }
        .player-name-input::placeholder {
            color: var(--old-rose);
            opacity: 0.6;
        }
        .player-name-input:focus {
            outline: 2px solid var(--electric-aqua);
        }

        /* Genre Grid */
        .genre-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        .genre-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            background: rgba(192, 245, 250, 0.1);
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .genre-item:hover {
            background: rgba(192, 245, 250, 0.2);
        }
        .genre-item.selected {
            background: rgba(175, 18, 90, 0.4);
        }
        .genre-checkbox {
            width: 18px;
            height: 18px;
            border: 2px solid var(--old-rose);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        .genre-item.selected .genre-checkbox {
            background: var(--cherry-rose);
            border-color: var(--cherry-rose);
        }
        .genre-checkbox::after {
            content: '';
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 2px;
            opacity: 0;
        }
        .genre-item.selected .genre-checkbox::after {
            opacity: 1;
        }
        .genre-name {
            font-size: 13px;
            color: var(--icy-aqua);
        }

        /* Year Range Slider */
        .year-display {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            font-size: 22px;
            font-weight: 700;
            color: var(--electric-aqua);
        }
        .range-slider {
            position: relative;
            height: 36px;
        }
        .range-slider input[type="range"] {
            position: absolute;
            width: 100%;
            height: 6px;
            background: transparent;
            pointer-events: none;
            -webkit-appearance: none;
        }
        .range-slider input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 22px;
            height: 22px;
            background: var(--cherry-rose);
            border-radius: 50%;
            cursor: pointer;
            pointer-events: auto;
            border: 3px solid var(--icy-aqua);
        }
        .slider-track {
            position: absolute;
            top: 8px;
            width: 100%;
            height: 6px;
            background: rgba(189, 139, 156, 0.3);
            border-radius: 3px;
        }
        .slider-range {
            position: absolute;
            top: 8px;
            height: 6px;
            background: var(--cherry-rose);
            border-radius: 3px;
        }

        /* Buttons */
        .start-btn {
            width: 100%;
            padding: 16px;
            font-size: 18px;
            font-family: 'DM Sans', sans-serif;
            font-weight: 700;
            background: var(--cherry-rose);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            margin-top: 15px;
            transition: background 0.2s;
        }
        .start-btn:hover {
            background: #c91a6a;
        }
        .start-btn:disabled {
            background: var(--old-rose);
            cursor: not-allowed;
        }

        /* Game Screen */
        .game-screen {
            display: none;
            width: 100%;
            text-align: center;
        }
        .game-screen.visible {
            display: block;
        }
        .play-btn {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(145deg, #c91a6a 0%, var(--cherry-rose) 50%, #8a0e45 100%);
            border: 3px solid var(--electric-aqua);
            box-shadow: 0 0 0 1px rgba(15, 26, 46, 0.3),
                        0 4px 24px rgba(175, 18, 90, 0.4),
                        inset 0 1px 0 rgba(255, 255, 255, 0.15);
            cursor: pointer;
            font-size: 40px;
            color: white;
            margin: 15px 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0 0 0 6px;
            line-height: 1;
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
        }
        .play-btn:hover {
            transform: scale(1.06);
            box-shadow: 0 0 20px rgba(135, 241, 255, 0.35),
                        0 6px 28px rgba(175, 18, 90, 0.5),
                        inset 0 1px 0 rgba(255, 255, 255, 0.2);
            border-color: var(--icy-aqua);
        }
        .play-btn:active {
            transform: scale(1.02);
        }
        .play-btn:disabled {
            background: linear-gradient(145deg, var(--old-rose) 0%, #9a6b7a 100%);
            border-color: rgba(192, 245, 250, 0.3);
            box-shadow: none;
            cursor: not-allowed;
            transform: none;
            opacity: 0.85;
        }
        .play-btn.playing {
            padding: 0;
            border-color: var(--electric-aqua);
            box-shadow: 0 0 24px rgba(135, 241, 255, 0.4),
                        0 4px 24px rgba(175, 18, 90, 0.35),
                        inset 0 1px 0 rgba(255, 255, 255, 0.2);
            animation: play-glow 2s ease-in-out infinite;
        }
        @keyframes play-glow {
            0%, 100% { box-shadow: 0 0 24px rgba(135, 241, 255, 0.4), 0 4px 24px rgba(175, 18, 90, 0.35), inset 0 1px 0 rgba(255, 255, 255, 0.2); }
            50% { box-shadow: 0 0 32px rgba(135, 241, 255, 0.55), 0 6px 28px rgba(175, 18, 90, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.25); }
        }
        .status {
            font-size: 14px;
            color: var(--old-rose);
            margin-bottom: 20px;
        }

        /* Player Guess Section */
        .players-guess-section {
            display: none;
        }
        .players-guess-section.visible {
            display: block;
        }
        .player-guess-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            padding: 12px;
            background: rgba(192, 245, 250, 0.08);
            border-radius: 10px;
        }
        .player-guess-name {
            flex: 1;
            font-size: 16px;
            font-weight: 600;
            color: var(--icy-aqua);
            text-align: left;
        }
        .player-guess-input {
            width: 90px;
            padding: 10px;
            font-size: 20px;
            text-align: center;
            border: none;
            border-radius: 8px;
            background: rgba(192, 245, 250, 0.15);
            color: var(--electric-aqua);
            font-family: 'DM Sans', sans-serif;
            font-weight: bold;
            letter-spacing: 2px;
        }
        .player-guess-input:focus {
            outline: 2px solid var(--electric-aqua);
        }
        .player-guess-input::placeholder {
            color: var(--old-rose);
            opacity: 0.5;
            font-size: 14px;
        }
        .player-guess-input.submitted {
            background: rgba(175, 18, 90, 0.3);
        }
        .submit-all-btn {
            width: 100%;
            padding: 14px;
            font-size: 16px;
            font-family: 'DM Sans', sans-serif;
            font-weight: 600;
            background: var(--cherry-rose);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            margin-top: 10px;
        }
        .submit-all-btn:hover {
            background: #c91a6a;
        }
        .submit-all-btn:disabled {
            background: var(--old-rose);
            cursor: not-allowed;
        }

        /* Result */
        .result {
            position: relative;
            margin-top: 20px;
            padding: 20px;
            padding-bottom: 60px;
            background: rgba(192, 245, 250, 0.1);
            border-radius: 16px;
            display: none;
        }
        .result.visible {
            display: block;
        }
        .result-year {
            font-size: 42px;
            font-weight: bold;
            color: var(--electric-aqua);
        }
        .result-song-title {
            font-size: 22px;
            font-weight: 600;
            color: var(--icy-aqua);
            margin: 8px 0 4px 0;
            line-height: 1.3;
        }
        .result-artist-name {
            font-size: 18px;
            font-weight: 500;
            color: var(--old-rose);
            margin: 0 0 16px 0;
            line-height: 1.3;
        }
        .result-song-info {
            text-align: left;
            font-size: 15px;
            line-height: 1.6;
            color: var(--icy-aqua);
            margin: 16px 0;
            padding: 14px;
            background: rgba(192, 245, 250, 0.08);
            border-radius: 12px;
        }
        .player-results {
            margin-top: 15px;
            text-align: left;
        }
        .player-result-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            margin-bottom: 6px;
            border-radius: 8px;
            font-size: 14px;
        }
        .player-result-row.perfect {
            background: rgba(135, 241, 255, 0.2);
        }
        .player-result-row.close {
            background: rgba(189, 139, 156, 0.2);
        }
        .player-result-row.far {
            background: rgba(175, 18, 90, 0.2);
        }
        .player-result-name {
            font-weight: 600;
            color: var(--icy-aqua);
        }
        .player-result-diff {
            color: var(--icy-aqua);
            font-size: 17px;
            font-weight: 600;
        }
        .player-result-row.perfect .player-result-diff {
            color: var(--electric-aqua);
        }

        /* Streaming Links */
        .streaming-links {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(189, 139, 156, 0.3);
        }
        .streaming-label {
            font-size: 11px;
            color: var(--old-rose);
            margin-bottom: 8px;
        }
        .streaming-buttons {
            display: flex;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        .stream-link {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 6px 12px;
            border-radius: 16px;
            text-decoration: none;
            font-size: 11px;
            font-weight: 500;
        }
        .stream-link.spotify { background: #1DB954; color: white; }
        .stream-link.apple { background: #fc3c44; color: white; }
        .stream-link.deezer { background: #a238ff; color: white; }
        .stream-link.tidal { background: #000; color: white; }

        .result-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        .result-btn {
            padding: 12px 25px;
            font-size: 14px;
            font-family: 'DM Sans', sans-serif;
            font-weight: 600;
            background: var(--old-rose);
            color: var(--dark-blue);
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        .result-btn:hover {
            background: var(--icy-aqua);
        }
        .settings-btn {
            position: absolute;
            bottom: 12px;
            left: 12px;
            padding: 0;
            font-size: 32px;
            background: none;
            color: var(--old-rose);
            border: none;
            cursor: pointer;
            opacity: 0.5;
            transition: opacity 0.2s;
        }
        .settings-btn:hover {
            opacity: 1;
            color: var(--icy-aqua);
        }

        /* Difficulty Selection */
        .difficulty-buttons {
            display: flex;
            gap: 8px;
        }
        .difficulty-btn {
            flex: 1;
            padding: 12px 8px;
            font-size: 13px;
            font-family: 'DM Sans', sans-serif;
            font-weight: 600;
            border: 2px solid var(--old-rose);
            background: transparent;
            color: var(--icy-aqua);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .difficulty-btn.selected {
            background: var(--cherry-rose);
            border-color: var(--cherry-rose);
            color: white;
        }
        .difficulty-btn:hover {
            border-color: var(--electric-aqua);
        }
        .standings-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 26, 46, 0.95);
            z-index: 100;
            padding: 20px;
            overflow-y: auto;
        }
        .standings-overlay.visible {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .standings-content {
            max-width: 400px;
            width: 100%;
            text-align: center;
        }
        .standings-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--electric-aqua);
            margin-bottom: 10px;
        }
        .standings-round {
            font-size: 14px;
            color: var(--old-rose);
            margin-bottom: 20px;
        }
        .standings-list {
            text-align: left;
        }
        .standings-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 16px;
            margin-bottom: 8px;
            border-radius: 10px;
            background: rgba(192, 245, 250, 0.1);
        }
        .standings-row:first-child {
            background: rgba(135, 241, 255, 0.2);
        }
        .standings-rank {
            font-size: 18px;
            font-weight: 700;
            color: var(--old-rose);
            width: 30px;
        }
        .standings-row:first-child .standings-rank {
            color: var(--electric-aqua);
        }
        .standings-name {
            flex: 1;
            font-size: 16px;
            font-weight: 600;
            color: var(--icy-aqua);
        }
        .standings-score {
            font-size: 16px;
            color: var(--old-rose);
        }
        .standings-score span {
            font-weight: 700;
            color: var(--electric-aqua);
        }
        .close-standings-btn {
            margin-top: 25px;
            padding: 14px 30px;
            font-size: 16px;
            font-family: 'DM Sans', sans-serif;
            font-weight: 600;
            background: var(--cherry-rose);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
        }

        /* Mobile-first responsive adjustments */

        /* Improve touch targets */
        .range-slider {
            height: 44px;
            padding: 10px 0;
        }
        .range-slider input[type="range"]::-webkit-slider-thumb {
            width: 28px;
            height: 28px;
        }
        .range-slider input[type="range"]::-moz-range-thumb {
            width: 28px;
            height: 28px;
            background: var(--cherry-rose);
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid var(--icy-aqua);
        }
        .slider-track {
            top: 19px;
        }
        .slider-range {
            top: 19px;
        }

        /* Prevent zoom on input focus (iOS) */
        input[type="text"],
        input[type="number"] {
            font-size: 16px;
        }

        /* Better touch feedback */
        .player-count-btn:active,
        .genre-item:active,
        .difficulty-btn:active,
        .intro-btn:active,
        .start-btn:active,
        .result-btn:active,
        .setup-nav button:active {
            transform: scale(0.97);
        }

        /* Small phones (< 360px) */
        @media (max-width: 359px) {
            body {
                padding: 15px;
                padding-bottom: 55px;
            }
            .intro-title {
                font-size: 28px;
            }
            .intro-lead {
                font-size: 15px;
            }
            .intro-section-title {
                font-size: 17px;
            }
            .intro-section-text {
                font-size: 14px;
            }
            h1 {
                font-size: 24px;
            }
            .genre-name {
                font-size: 12px;
            }
            .player-count-btn {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }
            .play-btn {
                width: 90px;
                height: 90px;
                font-size: 36px;
            }
            .result-year {
                font-size: 36px;
            }
        }

        /* Tablets and larger (>= 768px) */
        @media (min-width: 768px) {
            body {
                padding: 30px;
                padding-bottom: 70px;
            }
            .intro-title {
                font-size: 48px;
            }
            .intro-lead {
                font-size: 20px;
            }
            .intro-section-title {
                font-size: 22px;
            }
            h1 {
                font-size: 32px;
            }
            .genre-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            .genre-item {
                padding: 12px 14px;
            }
            .genre-name {
                font-size: 14px;
            }
            .play-btn {
                width: 120px;
                height: 120px;
                font-size: 48px;
            }
            .player-guess-row {
                padding: 14px 16px;
            }
            .result {
                padding: 25px;
                padding-bottom: 65px;
            }
            .result-year {
                font-size: 48px;
            }
            .result-song-title {
                font-size: 24px;
            }
            .result-artist-name {
                font-size: 20px;
            }
            .standings-content {
                max-width: 450px;
            }
        }

        /* Desktop (>= 1024px) */
        @media (min-width: 1024px) {
            .genre-grid {
                grid-template-columns: repeat(4, 1fr);
            }
            .intro-screen {
                padding: 50px 0;
            }
        }

        /* Landscape mode on phones */
        @media (max-height: 500px) and (orientation: landscape) {
            .intro-screen {
                padding: 15px 0;
            }
            .intro-title {
                font-size: 28px;
                margin-bottom: 20px;
            }
            .intro-lead {
                margin-bottom: 20px;
            }
            .intro-section {
                margin-bottom: 15px;
            }
            .intro-ready {
                margin-top: 20px;
            }
            .play-btn {
                width: 80px;
                height: 80px;
                font-size: 32px;
                margin: 10px 0;
            }
            .standings-overlay {
                padding: 15px;
            }
        }

        /* Safe area for notched phones */
        @supports (padding: env(safe-area-inset-bottom)) {
            body {
                padding-bottom: calc(60px + env(safe-area-inset-bottom));
            }
            .footer {
                padding-bottom: calc(12px + env(safe-area-inset-bottom));
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Intro Screen -->
        <div class="intro-screen" id="introScreen">
            <div class="intro-title">MusicNerd</div>

            <div class="intro-lead">
                Ihr hört gemeinsam einen 30-Sekunden-Ausschnitt eines Songs – ohne Titel, ohne Hinweise.
            </div>

            <div class="intro-section">
                <div class="intro-section-title">Schätzt das Jahr.</div>
                <div class="intro-section-text">Jede*r tippt, wann der Song erschienen ist.<br>Kein Googeln. Nur Gehör, Erfahrung und Gefühl.</div>
            </div>

            <div class="intro-section">
                <div class="intro-section-title">Auflösung & Einordnung.</div>
                <div class="intro-section-text">Nach der Auflösung seht ihr, wer am nächsten dran war – und warum der Song vielleicht täuscht.</div>
            </div>

            <div class="intro-section">
                <div class="intro-section-title">Wer gewinnt?</div>
                <div class="intro-section-text">Am Ende zählt, wer insgesamt die geringste Abweichung hat.</div>
            </div>

            <div class="intro-ready">Bereit?</div>
            <button class="intro-btn" onclick="showSetup()">Los geht's!</button>
        </div>

        <!-- Setup Screen 1: Players -->
        <div class="setup-screen" id="setupPlayers" style="display: none;">
            <h1 style="margin-top: 0;">Wer spielt mit?</h1>
            <div class="setup-section">
                <label class="setup-label">Anzahl Spieler</label>
                <div class="player-count" id="playerCount"></div>
            </div>
            <div class="setup-section">
                <label class="setup-label">Namen</label>
                <div class="player-inputs" id="playerInputs"></div>
            </div>
            <div class="setup-nav">
                <button class="next-btn" onclick="showSetupOptions()">Weiter</button>
            </div>
        </div>

        <!-- Setup Screen 2: Options -->
        <div class="setup-screen" id="setupOptions" style="display: none;">
            <h1 style="margin-top: 0;">Spieloptionen</h1>
            <!-- Genres -->
            <div class="setup-section">
                <label class="setup-label">Genres</label>
                <div class="genre-grid" id="genreGrid"></div>
            </div>

            <!-- Year Range -->
            <div class="setup-section">
                <label class="setup-label">Zeitraum</label>
                <div class="year-display">
                    <span id="yearMin">1940</span>
                    <span id="yearMax">2025</span>
                </div>
                <div class="range-slider">
                    <div class="slider-track"></div>
                    <div class="slider-range" id="sliderRange"></div>
                    <input type="range" id="rangeMin" min="1940" max="2025" value="1940">
                    <input type="range" id="rangeMax" min="1940" max="2025" value="2025">
                </div>
            </div>

            <!-- Difficulty -->
            <div class="setup-section">
                <label class="setup-label">Schwierigkeit</label>
                <div class="difficulty-buttons" id="difficultyButtons"></div>
            </div>

            <div class="setup-nav">
                <button class="back-btn" onclick="showSetupPlayers()">Zurück</button>
                <button class="next-btn" id="startBtn" onclick="startGame()">Spiel starten</button>
            </div>
        </div>

        <!-- Game Screen -->
        <div class="game-screen" id="gameScreen">
            <button class="play-btn" id="playBtn" onclick="playPreview()">▶</button>
            <div class="status" id="status">Klicke zum Abspielen</div>

            <div class="players-guess-section" id="playersGuessSection">
                <div id="playerGuessRows"></div>
                <button class="submit-all-btn" id="submitAllBtn" onclick="submitAllGuesses()">Alle Tipps abgeben</button>
            </div>

            <div class="result" id="result">
                <div class="result-year" id="resultYear"></div>
                <div class="result-song-title" id="resultSongTitle"></div>
                <div class="result-artist-name" id="resultArtistName"></div>
                <div class="result-song-info" id="resultSongInfo" style="display: none;">
                    <div id="songInfoText"></div>
                </div>
                <div class="player-results" id="playerResults"></div>
                <div class="streaming-links">
                    <div class="streaming-label">Ganzen Song hören:</div>
                    <div class="streaming-buttons" id="streamingButtons"></div>
                </div>
                <div class="result-buttons">
                    <button class="result-btn" onclick="showStandings()">Zwischenstand</button>
                    <button class="result-btn" onclick="loadNewSong()">Nächster Song</button>
                </div>
                <button class="settings-btn" onclick="backToSetup()" title="Einstellungen">⚙</button>
            </div>

            <!-- Standings Overlay -->
            <div class="standings-overlay" id="standingsOverlay">
                <div class="standings-content">
                    <div class="standings-title">Zwischenstand</div>
                    <div class="standings-round" id="standingsRound"></div>
                    <div class="standings-list" id="standingsList"></div>
                    <button class="close-standings-btn" onclick="hideStandings()">Weiter spielen</button>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        powered by <a href="https://www.vais.one" target="_blank">Vertical AI Solutions</a>
    </footer>

    <audio id="audioPlayer"></audio>

    <script>
        function showSetup() {
            document.getElementById('introScreen').style.display = 'none';
            document.getElementById('setupPlayers').style.display = 'block';
        }

        function showSetupPlayers() {
            document.getElementById('setupOptions').style.display = 'none';
            document.getElementById('setupPlayers').style.display = 'block';
        }

        function showSetupOptions() {
            document.getElementById('setupPlayers').style.display = 'none';
            document.getElementById('setupOptions').style.display = 'block';
        }

        /* Songauswahl: Spaß beim Datieren.
   Beginner: NUR einfache, SEHR BEKANNTE Mega-Hits – sonst macht Beginner keinen Sinn.
   Intermediate: bekannte Artists, unerwartete Songs. Expert: systematisch falsch datiert. */
        const genres = [
            { id: 'rock', name: 'Rock',
              beginner: ['queen bohemian rhapsody', 'led zeppelin stairway to heaven', 'ac dc back in black', 'eagles hotel california', 'guns n roses sweet child o mine', 'bon jovi livin on a prayer', 'journey dont stop believin'],
              intermediate: ['the smiths how soon is now', 'pixies where is my mind', 'u2 with or without you', 'fleetwood mac dreams', 'the cure just like heaven'],
              expert: ['new order bizarre love triangle', 'the jesus and mary chain just like honey', 'echo and the bunnymen the killing moon', 'the church under the milky way', 'the replacements left of the dial']
            },
            { id: 'pop', name: 'Pop',
              beginner: ['abba dancing queen', 'madonna like a virgin', 'whitney houston i wanna dance with somebody', 'phil collins in the air tonight', 'toto africa', 'cyndi lauper girls just want to have fun', 'george michael faith', 'michael jackson billie jean'],
              intermediate: ['kate bush running up that hill', 'tears for fears head over heels', 'the human league dont you want me', 'eurythmics here comes the rain again', 'prefab sprout when love breaks down'],
              expert: ['talk talk its my life', 'scritti politti perfect way', 'aztec camera oblivion', 'the blue nile tinseltown in the rain', 'the the uncertain smile']
            },
            { id: 'hiphop', name: 'Hip-Hop',
              beginner: ['eminem lose yourself', '50 cent in da club', 'outkast hey ya', 'dr dre still dre', 'snoop dogg drop it like its hot', 'kanye west gold digger', 'black eyed peas where is the love'],
              intermediate: ['a tribe called quest bonita applebum', 'de la soul me myself and i', 'digable planets rebirth of slick', 'the roots you got me', 'common the light'],
              expert: ['gang starr mass appeal', 'pharcyde runnin', 'digable planets rebirth', 'slum village fall in love', 'pete rock they reminisce']
            },
            { id: 'electronic', name: 'Electronic',
              beginner: ['daft punk get lucky', 'depeche mode enjoy the silence', 'new order blue monday', 'eurythmics sweet dreams', 'pet shop boys west end girls', 'darude sandstorm', 'robert miles children'],
              intermediate: ['new order true faith', 'depeche mode enjoy the silence', 'massive attack unfinished sympathy', 'portishead sour times', 'underworld born slippy'],
              expert: ['leftfield open up', 'orb little fluffly clouds', 'the orb blue room', 'future sound of london papua new guinea', 'lfo lfo']
            },
            { id: 'rnb', name: 'R&B / Soul',
              beginner: ['stevie wonder superstition', 'marvin gaye lets get it on', 'aretha franklin respect', 'lionel richie all night long', 'beyonce crazy in love', 'usher yeah', 'al green lets stay together'],
              intermediate: ['sade smooth operator', 'janet jackson thats the way love goes', 'maxwell ascension', 'dangelo lady', 'erykah badu on and on'],
              expert: ['donny hathaway a song for you', 'minnie riperton lovin you', 'robert glasper black radio', 'dangelo untitled', 'maxwell sumthin sumthin']
            },
            { id: 'jazz', name: 'Jazz',
              beginner: ['dave brubeck take five', 'louis armstrong what a wonderful world', 'ella fitzgerald summertime', 'frank sinatra fly me to the moon', 'miles davis so what', 'glenn miller in the mood', 'nat king cole unforgettable'],
              intermediate: ['weather report birdland', 'herbie hancock chameleon', 'return to forever spain', 'mahavishnu orchestra meeting of the spirits', 'stanley clarke school days'],
              expert: ['miles davis shhh peaceful', 'sun ra space is the place', 'don cherry brown rice', 'pharoah sanders the creator has a master plan', 'alice coltrane journey in satchidananda']
            },
            { id: 'metal', name: 'Metal',
              beginner: ['metallica enter sandman', 'iron maiden the trooper', 'black sabbath paranoid', 'ac dc thunderstruck', 'guns n roses welcome to the jungle', 'def leppard pour some sugar on me', 'scorpions wind of change'],
              intermediate: ['faith no more epic', 'living colour cult of personality', 'soundgarden black hole sun', 'rage against the machine killing in the name', 'tool sober'],
              expert: ['meshuggah bleed', 'gojira flying whales', 'tool lateralus', 'system of a down chop suey', 'mastodon blood and thunder']
            },
            { id: 'country', name: 'Country',
              beginner: ['johnny cash ring of fire', 'dolly parton jolene', 'john denver country roads', 'kenny rogers the gambler', 'willie nelson on the road again', 'glen campbell rhinestone cowboy', 'garth brooks friends in low places'],
              intermediate: ['emmylou harris boulder to birmingham', 'gram parsons return of the grievous angel', 'lucinda williams car wheels', 'gillian welch revelator', 'steve earle copperhead road'],
              expert: ['townes van zandt pancho and lefty', 'guy clark la freeway', 'blaze foley cold cold world', 'john prine sam stone', 'terry allen amarillo highway']
            },
            { id: 'indie', name: 'Indie',
              beginner: ['nirvana smells like teen spirit', 'oasis wonderwall', 'radiohead creep', 'the killers mr brightside', 'arctic monkeys i bet you look good on the dancefloor', 'franz ferdinand take me out', 'the strokes last nite'],
              intermediate: ['pavement range life', 'built to spill carry the zero', 'modest mouse float on', 'the shins new slang', 'death cab for cutie soul meets body'],
              expert: ['slint good morning captain', 'low lullaby', 'codeine realize', 'bedhead bedside table', 'low the one you keep']
            },
            { id: 'punk', name: 'Punk',
              beginner: ['ramones blitzkrieg bop', 'sex pistols anarchy in the uk', 'the clash london calling', 'green day basket case', 'blink 182 all the small things', 'blondie heart of glass', 'talking heads psycho killer'],
              intermediate: ['the replacements alex chilton', 'hüsker dü dont want to know if you are lonely', 'the replacements bastards of young', 'minutemen corona', 'fugazi waiting room'],
              expert: ['wire 12xu', 'television marquee moon', 'the stooges 1970', 'wire outdoor miner', 'buzzcocks ever fallen in love']
            },
            { id: 'klassik', name: 'Klassik',
              beginner: ['beethoven symphony 5', 'mozart eine kleine nachtmusik', 'vivaldi four seasons spring', 'pachelbel canon in d', 'tchaikovsky swan lake', 'bach air on the g string', 'handel hallelujah'],
              intermediate: ['ravel bolero', 'saint-saens danse macabre', 'holst mars', 'grieg in the hall of the mountain king', 'dvorak new world largo'],
              expert: ['stravinsky rite of spring', 'ligeti lux aeterna', 'penderecki threnody for the victims', 'gorecki symphony 3', 'part fratres']
            },
            { id: 'techno', name: 'Techno',
              beginner: ['daft punk around the world', 'darude sandstorm', 'robert miles children', 'fatboy slim praise you', 'chemical brothers block rockin beats', 'tiesto adagio for strings', 'atb 9pm till i come'],
              intermediate: ['underworld dark and long', 'orbital the box', 'leftfield release the pressure', 'the prodigy no good', 'lfo freak'],
              expert: ['jeff mills the bells', 'surgeon badger bite', 'regis execution', 'surgeon magnesium', 'marcel dettmann corebox']
            }
        ];

        const difficulties = [
            { id: 'beginner', name: 'Beginner' },
            { id: 'intermediate', name: 'Intermediate' },
            { id: 'expert', name: 'Expert' }
        ];

        /** OpenAI-Proxy-URL: Lokal = localhost, auf deinem Server = deine API-Adresse eintragen (z. B. https://deine-domain.de/api/song-info). */
        const OPENAI_PROXY_URL = 'http://localhost:3001/api/song-info';
        const OPENAI_SUGGEST_URL = (OPENAI_PROXY_URL || '').replace(/\/api\/song-info\/?$/, '') + '/api/suggest-song';

        /** Prompt für KI-generierte Song-Erläuterung (z. B. bei API-Anbindung). */
        const SONG_INFO_PROMPT = `Erkläre kurz, warum dieser Song zeitlich so einzuordnen ist, wie angezeigt.
Beziehe dich dabei auf konkrete hörbare Merkmale dieses Songs (z. B. Drum-Sound, Synths, Vocal-Stil, Arrangement, Mix, Genrephase).
Nenne mindestens zwei konkrete Hinweise, an denen man die Epoche erkennen kann.
Du kannst optional – aber nicht in jeder Erklärung – erwähnen, warum viele den Song zu früh oder zu spät einschätzen; wechsle das ab, sonst wirkt es repetitiv.
Schreibe im Ton eines musikbegeisterten Freundes: erklärend, neugierig, wohlwollend.
Vermeide abstrakte oder leere Formulierungen wie „kultureller Kontext", „Stilistik", „lässt sich einordnen".
Nenne weder Songtitel noch Erscheinungsjahr in deiner Antwort – beides steht bereits darüber.

Zusätzliche harte Regel: Jeder Satz muss sich auf etwas Hörbares oder musikalisch Konkretes beziehen.`;

        /**
         * Erzeugt die Song-Info zur Auflösung je nach Schwierigkeitslevel.
         * Folgt SONG_INFO_PROMPT: konkrete hörbare Merkmale, zwei Epochen-Hinweise, warum falsch datiert, Ton: musikbegeisterter Freund.
         */
        function getSongInfoForDifficulty(artistName, trackName, releaseYear, difficulty) {
            const decade = Math.floor(releaseYear / 10) * 10;
            const decadeLabel = releaseYear < 2000 ? `${decade}er` : `${decade}`;

            if (difficulty === 'beginner') {
                return {
                    label: '',
                    text: `Der Drum-Sound und der Mix verraten die ${decadeLabel}-Jahre – der Vocal-Stil und das Arrangement passen genau in diese Phase.`
                };
            }
            if (difficulty === 'intermediate') {
                return {
                    label: '',
                    text: `Am Synth-Sound und am Arrangement hört man die ${decadeLabel}-Jahre; der Mix und die Art, wie die Stimme sitzt, sind typisch für die Zeit.`
                };
            }
            if (difficulty === 'expert') {
                return {
                    label: '',
                    text: `Drum-Sound und Wahl der Synths (oder Gitarrenverzerrung) sind zwei klare Anhaltspunkte für die ${decadeLabel}-Jahre – Arrangement und Mix bestätigen das.`
                };
            }
            return null;
        }

        /** Holt eine Liste von Song-Vorschlägen von der API (Kuratoren-Prompt). Gibt Array von { artist, song } oder []. */
        async function fetchSuggestSongList(genreNames, difficulty, yearMinVal, yearMaxVal, count = 12) {
            const url = (OPENAI_SUGGEST_URL || '').trim();
            if (!url) return [];
            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        genres: genreNames,
                        difficulty,
                        yearMin: yearMinVal,
                        yearMax: yearMaxVal,
                        count
                    })
                });
                if (!res.ok) return [];
                const data = await res.json();
                const list = Array.isArray(data.songs) ? data.songs : [];
                return list.filter((x) => x && x.artist && x.song).map((x) => ({ artist: String(x.artist).trim(), song: String(x.song).trim() }));
            } catch (e) {
                console.error('Suggest-SongList:', e);
                return [];
            }
        }

        /** Holt Song-Erklärung von OpenAI über Proxy (GPT-4.1 mini). Gibt null bei Fehler oder fehlendem Proxy. */
        async function fetchSongInfoFromOpenAI(artistName, trackName, releaseYear) {
            const proxyUrl = (OPENAI_PROXY_URL || '').trim();
            if (!proxyUrl) return null;

            const userContent = `${SONG_INFO_PROMPT}

(Kontext für dich: Song „${trackName}" von ${artistName}, Erscheinungsjahr ${releaseYear})

Antworte nur mit dem Erklärungstext. Keine Überschrift, keine Nennung von Songtitel oder Jahr – das steht schon darüber.`;

            try {
                const res = await fetch(proxyUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        artistName,
                        trackName,
                        releaseYear,
                        prompt: SONG_INFO_PROMPT,
                        userContent
                    })
                });
                if (!res.ok) throw new Error(res.statusText);
                const data = await res.json();
                if (data.error) throw new Error(data.error);
                return (data.text || data.content || '').trim();
            } catch (e) {
                console.error('OpenAI Song-Info:', e);
                return null;
            }
        }

        const currentYear = new Date().getFullYear();
        let playerCount = 2;
        let players = [];
        let selectedGenres = new Set(['rock', 'pop', 'indie']);
        let selectedDifficulty = 'beginner';
        let yearMin = 1940;
        let yearMax = currentYear;
        let currentSong = null;
        let guessSubmitted = false;
        let roundNumber = 0;
        let songQueue = [];

        function init() {
            renderPlayerCount();
            renderPlayerInputs();
            renderGenres();
            renderDifficulty();
            setupRangeSlider();
            updateStartButton();
        }

        function renderPlayerCount() {
            const container = document.getElementById('playerCount');
            container.innerHTML = [1,2,3,4,5,6].map(n => `
                <button class="player-count-btn ${n === playerCount ? 'selected' : ''}" onclick="setPlayerCount(${n})">${n}</button>
            `).join('');
        }

        function setPlayerCount(n) {
            playerCount = n;
            renderPlayerCount();
            renderPlayerInputs();
            updateStartButton();
        }

        function renderPlayerInputs() {
            const container = document.getElementById('playerInputs');
            container.innerHTML = Array.from({length: playerCount}, (_, i) => `
                <input type="text" class="player-name-input" placeholder="Spieler ${i+1}" data-index="${i}" maxlength="20">
            `).join('');
        }

        function renderGenres() {
            const grid = document.getElementById('genreGrid');
            grid.innerHTML = genres.map(g => `
                <div class="genre-item ${selectedGenres.has(g.id) ? 'selected' : ''}" data-genre="${g.id}">
                    <span class="genre-checkbox"></span>
                    <span class="genre-name">${g.name}</span>
                </div>
            `).join('');

            grid.querySelectorAll('.genre-item').forEach(item => {
                item.addEventListener('click', () => {
                    const id = item.dataset.genre;
                    if (selectedGenres.has(id)) {
                        selectedGenres.delete(id);
                        item.classList.remove('selected');
                    } else {
                        selectedGenres.add(id);
                        item.classList.add('selected');
                    }
                    updateStartButton();
                });
            });
        }

        function renderDifficulty() {
            const container = document.getElementById('difficultyButtons');
            container.innerHTML = difficulties.map(d => `
                <button class="difficulty-btn ${d.id === selectedDifficulty ? 'selected' : ''}" onclick="setDifficulty('${d.id}')">${d.name}</button>
            `).join('');
        }

        function setDifficulty(id) {
            selectedDifficulty = id;
            renderDifficulty();
        }

        function setupRangeSlider() {
            const rangeMin = document.getElementById('rangeMin');
            const rangeMax = document.getElementById('rangeMax');
            rangeMin.max = rangeMax.max = currentYear;
            rangeMax.value = currentYear;
            document.getElementById('yearMax').textContent = currentYear;

            function update() {
                let min = parseInt(rangeMin.value);
                let max = parseInt(rangeMax.value);
                if (min > max - 5) {
                    if (this === rangeMin) { min = max - 5; rangeMin.value = min; }
                    else { max = min + 5; rangeMax.value = max; }
                }
                yearMin = min; yearMax = max;
                document.getElementById('yearMin').textContent = min;
                document.getElementById('yearMax').textContent = max;
                const minP = ((min - 1940) / (currentYear - 1940)) * 100;
                const maxP = ((max - 1940) / (currentYear - 1940)) * 100;
                document.getElementById('sliderRange').style.left = minP + '%';
                document.getElementById('sliderRange').style.width = (maxP - minP) + '%';
            }
            rangeMin.addEventListener('input', update);
            rangeMax.addEventListener('input', update);
            update.call(rangeMin);
        }

        function updateStartButton() {
            document.getElementById('startBtn').disabled = selectedGenres.size === 0;
        }

        async function startGame() {
            players = [];
            document.querySelectorAll('.player-name-input').forEach((input, i) => {
                players.push({ name: input.value.trim() || `Spieler ${i+1}`, guess: null, totalDiff: 0 });
            });
            roundNumber = 0;
            songQueue = [];

            document.getElementById('setupOptions').style.display = 'none';
            document.getElementById('gameScreen').classList.add('visible');
            renderPlayerGuessRows();
            const statusEl = document.getElementById('status');
            statusEl.textContent = 'Lade Songliste…';
            document.getElementById('playBtn').disabled = true;
            document.getElementById('playBtn').textContent = '⏳';

            const genreNames = genres.filter((g) => selectedGenres.has(g.id)).map((g) => g.name);
            if (genreNames.length && OPENAI_SUGGEST_URL) {
                const list = await fetchSuggestSongList(genreNames, selectedDifficulty, yearMin, yearMax, 12);
                if (list.length) songQueue = list;
            }
            statusEl.textContent = '';
            loadNewSong();
        }

        function renderPlayerGuessRows() {
            const container = document.getElementById('playerGuessRows');
            container.innerHTML = players.map((p, i) => `
                <div class="player-guess-row">
                    <span class="player-guess-name">${p.name}</span>
                    <input type="text" class="player-guess-input" data-player="${i}" maxlength="4" placeholder="Jahr" inputmode="numeric">
                </div>
            `).join('');

            container.querySelectorAll('.player-guess-input').forEach(input => {
                input.addEventListener('input', e => {
                    e.target.value = e.target.value.replace(/[^0-9]/g, '');
                });
            });
        }

        function backToSetup() {
            document.getElementById('audioPlayer').pause();
            document.getElementById('gameScreen').classList.remove('visible');
            document.getElementById('setupOptions').style.display = 'block';
            document.getElementById('result').classList.remove('visible');
            document.getElementById('playersGuessSection').classList.remove('visible');
        }

        async function loadNewSong() {
            guessSubmitted = false;
            currentSong = null;
            const playBtn = document.getElementById('playBtn');
            const status = document.getElementById('status');
            playBtn.disabled = true;
            playBtn.textContent = '⏳';
            playBtn.classList.remove('playing');
            document.getElementById('playersGuessSection').classList.remove('visible');
            document.getElementById('result').classList.remove('visible');
            document.getElementById('submitAllBtn').disabled = false;
            status.textContent = 'Lade Song...';
            document.getElementById('audioPlayer').pause();

            // Reset inputs
            document.querySelectorAll('.player-guess-input').forEach(input => {
                input.value = '';
                input.classList.remove('submitted');
                input.disabled = false;
            });
            players.forEach(p => p.guess = null);

            const isNoCover = (s) => {
                const trackLower = (s.trackName || '').toLowerCase();
                const albumLower = (s.collectionName || '').toLowerCase();
                const combined = trackLower + ' ' + albumLower;
                if (combined.includes('live') || combined.includes('remaster') || combined.includes('remix') || combined.includes('extended') || combined.includes('deluxe') || combined.includes('anniversary') || combined.includes('reissue') || combined.includes('re-record')) return false;
                if (/\d{2,4}\s*th\s*(anniversary|year)/.test(combined) || /take\s*\d+/.test(combined)) return false;
                if (combined.includes('outtake') || combined.includes(' demo') || combined.includes('(demo)') || combined.includes('alternate') || combined.includes('session') || combined.includes('previously unreleased') || combined.includes('unreleased')) return false;
                if (combined.includes('(cover)') || combined.includes('cover version') || combined.includes('cover of') || combined.includes('cover by') || combined.includes('covered by')) return false;
                if (albumLower.includes(' covers') || albumLower.includes('covers ') || albumLower.includes('tribute to') || trackLower.endsWith(' - cover') || combined.includes('chant masters') || combined.includes('karaoke') || combined.includes('tribute band')) return false;
                if (combined.includes('movie') || combined.includes('motion picture') || combined.includes('from the film') || combined.includes('from the motion picture') || trackLower.includes(' clip')) return false;
                return true;
            };

            if (songQueue.length === 0 && OPENAI_SUGGEST_URL) {
                const genreNames = genres.filter((g) => selectedGenres.has(g.id)).map((g) => g.name);
                if (genreNames.length) {
                    status.textContent = 'Lade Songliste…';
                    const list = await fetchSuggestSongList(genreNames, selectedDifficulty, yearMin, yearMax, 12);
                    if (list.length) songQueue = list;
                    status.textContent = 'Lade Song...';
                }
            }

            for (let i = 0; i < songQueue.length; i++) {
                const suggestion = songQueue[i];
                if (!suggestion?.artist || !suggestion?.song) continue;
                try {
                    const query = `${suggestion.artist} ${suggestion.song}`;
                    const res = await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(query)}&media=music&entity=song&limit=50`);
                    const data = await res.json();
                    const valid = (data.results || []).filter(s => {
                        if (!s.previewUrl) return false;
                        const year = new Date(s.releaseDate).getFullYear();
                        if (year < yearMin || year > yearMax) return false;
                        if (!isNoCover(s)) return false;
                        const resultArtist = (s.artistName || '').toLowerCase();
                        const wantArtist = suggestion.artist.toLowerCase();
                        if (!resultArtist.includes(wantArtist) && !wantArtist.split(/\s+/).some(w => w.length > 2 && resultArtist.includes(w))) return false;
                        return true;
                    });
                    if (valid.length) {
                        valid.sort((a, b) => new Date(a.releaseDate) - new Date(b.releaseDate));
                        currentSong = valid[0];
                        songQueue.splice(i, 1);
                        document.getElementById('audioPlayer').src = currentSong.previewUrl;
                        playBtn.disabled = false;
                        playBtn.textContent = '▶';
                        status.textContent = 'Klicke zum Abspielen';
                        return;
                    }
                } catch (e) { console.error(e); }
            }

            const queries = [];
            genres.forEach(g => { if (selectedGenres.has(g.id)) queries.push(...g[selectedDifficulty]); });
            let attempts = 0;
            while (attempts < 10) {
                const query = queries[Math.floor(Math.random() * queries.length)];
                try {
                    const res = await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(query)}&media=music&entity=song&limit=50`);
                    const data = await res.json();
                    const valid = (data.results || []).filter(s => {
                        if (!s.previewUrl) return false;
                        const year = new Date(s.releaseDate).getFullYear();
                        if (year < yearMin || year > yearMax) return false;
                        if (!isNoCover(s)) return false;
                        return true;
                    });
                    const stopwords = ['the', 'and', 'a', 'an', 'of', 'in', 'on', 'at', 'to', 'for', 'or', 'with'];
                    const queryLower = query.toLowerCase();
                    const queryWords = queryLower.split(/\s+/).filter(w => w.length > 1 && !stopwords.includes(w));
                    const validMatch = valid.filter(s => {
                        const artist = (s.artistName || '').toLowerCase();
                        const artistWords = artist.split(/\s+/).filter(w => w.length > 1 && !stopwords.includes(w) && !/^[&']+$/.test(w));
                        if (artistWords.length === 0) return false;
                        return artistWords.some(aw => queryWords.includes(aw));
                    });
                    const finalValid = validMatch.length ? validMatch : valid;
                    if (finalValid.length) {
                        finalValid.sort((a, b) => new Date(a.releaseDate) - new Date(b.releaseDate));
                        currentSong = finalValid[0];
                        document.getElementById('audioPlayer').src = currentSong.previewUrl;
                        playBtn.disabled = false;
                        playBtn.textContent = '▶';
                        status.textContent = 'Klicke zum Abspielen';
                        return;
                    }
                } catch (e) { console.error(e); }
                attempts++;
            }
            status.textContent = 'Kein Song gefunden';
            playBtn.textContent = '?';
        }

        function playPreview() {
            if (!currentSong) return;
            const audio = document.getElementById('audioPlayer');
            const playBtn = document.getElementById('playBtn');
            const status = document.getElementById('status');

            if (audio.paused) {
                audio.play();
                playBtn.textContent = '⏸';
                playBtn.classList.add('playing');
                status.textContent = 'Hört genau hin...';
                if (!guessSubmitted) {
                    setTimeout(() => {
                        document.getElementById('playersGuessSection').classList.add('visible');
                        document.querySelector('.player-guess-input')?.focus();
                    }, 2000);
                }
            } else {
                audio.pause();
                playBtn.textContent = '▶';
                playBtn.classList.remove('playing');
                status.textContent = 'Pausiert';
            }
        }

        document.getElementById('audioPlayer').addEventListener('ended', () => {
            document.getElementById('playBtn').textContent = '▶';
            document.getElementById('playBtn').classList.remove('playing');
            document.getElementById('status').textContent = 'Gebt eure Tipps ab!';
        });

        function submitAllGuesses() {
            if (guessSubmitted || !currentSong) return;

            // Collect guesses
            let allValid = true;
            document.querySelectorAll('.player-guess-input').forEach((input, i) => {
                const val = parseInt(input.value);
                if (!val || val < 1900 || val > currentYear + 5) {
                    input.style.outline = '2px solid var(--cherry-rose)';
                    setTimeout(() => input.style.outline = '', 1000);
                    allValid = false;
                } else {
                    players[i].guess = val;
                    input.classList.add('submitted');
                    input.disabled = true;
                }
            });

            if (!allValid) return;

            guessSubmitted = true;
            document.getElementById('submitAllBtn').disabled = true;

            const correctYear = new Date(currentSong.releaseDate).getFullYear();

            document.getElementById('resultYear').textContent = correctYear;
            document.getElementById('resultSongTitle').textContent = currentSong.trackName || '';
            document.getElementById('resultArtistName').textContent = currentSong.artistName || '';

            // Song-Info: immer per API (Fallback nur Kurzhinweis, wenn Proxy fehlt)
            const songInfoEl = document.getElementById('resultSongInfo');
            const songInfoTextEl = document.getElementById('songInfoText');
            songInfoEl.style.display = 'block';
            songInfoTextEl.textContent = 'Erklärung wird geladen…';

            (async () => {
                const apiText = await fetchSongInfoFromOpenAI(
                    currentSong.artistName,
                    currentSong.trackName,
                    correctYear
                );
                if (apiText) {
                    songInfoTextEl.textContent = apiText;
                } else {
                    songInfoEl.style.display = 'none';
                }
            })();

            // Sort players by accuracy
            const sorted = [...players].sort((a, b) => Math.abs(a.guess - correctYear) - Math.abs(b.guess - correctYear));

            document.getElementById('playerResults').innerHTML = sorted.map(p => {
                const diff = Math.abs(p.guess - correctYear);
                let cls = 'far';
                if (diff === 0) cls = 'perfect';
                else if (diff <= 5) cls = 'close';

                let diffText = diff === 0 ? 'Perfekt!' : `${diff} Jahr${diff > 1 ? 'e' : ''} daneben! (dein Tipp: ${p.guess})`;
                return `
                    <div class="player-result-row ${cls}">
                        <span class="player-result-name">${p.name}</span>
                        <span class="player-result-diff">${diffText}</span>
                    </div>
                `;
            }).join('');

            const q = encodeURIComponent(`${currentSong.artistName} ${currentSong.trackName}`);
            document.getElementById('streamingButtons').innerHTML = `
                <a href="spotify:search:${q}" class="stream-link spotify">Spotify</a>
                <a href="music://search?term=${q}" class="stream-link apple">Apple</a>
                <a href="deezer://www.deezer.com/search/${q}" class="stream-link deezer">Deezer</a>
                <a href="tidal://search/${q}" class="stream-link tidal">Tidal</a>
            `;

            // Update total scores for standings
            players.forEach(p => {
                const diff = Math.abs(p.guess - correctYear);
                p.totalDiff += diff;
            });
            roundNumber++;

            document.getElementById('playersGuessSection').classList.remove('visible');
            document.getElementById('result').classList.add('visible');
            document.getElementById('status').textContent = '';
        }

        function showStandings() {
            const overlay = document.getElementById('standingsOverlay');
            const roundText = document.getElementById('standingsRound');
            const list = document.getElementById('standingsList');

            roundText.textContent = `Nach ${roundNumber} Runde${roundNumber > 1 ? 'n' : ''}`;

            // Sort by total difference (lowest is best)
            const sorted = [...players].sort((a, b) => a.totalDiff - b.totalDiff);

            list.innerHTML = sorted.map((p, i) => {
                const avg = roundNumber > 0 ? (p.totalDiff / roundNumber).toFixed(1) : 0;
                return `
                    <div class="standings-row">
                        <span class="standings-rank">${i + 1}.</span>
                        <span class="standings-name">${p.name}</span>
                        <span class="standings-score"><span>${p.totalDiff}</span> Jahre Abweichung</span>
                    </div>
                `;
            }).join('');

            overlay.classList.add('visible');
        }

        function hideStandings() {
            document.getElementById('standingsOverlay').classList.remove('visible');
        }

        init();
    </script>
</body>
</html>
